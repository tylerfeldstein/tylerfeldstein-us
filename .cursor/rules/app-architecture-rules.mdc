---
description: Application Architecture Rules
globs: 
alwaysApply: false
---
## ğŸ—ï¸ Application Architecture Rules

### ğŸ“Œ Overview

This project is built using **Next.js 15**, **TailwindCSS**, **TypeScript**, **Shadcn UI**, **Convex Database**, and **Inngest for AI agents**. Our architecture emphasizes **real-time reactivity**, **modular design**, and **scalable AI automation**.

---

### ğŸ—ï¸ General Architecture Guidelines

âœ… **Next.js 15 App Router** â€“ Use the new App Directory and Server Components architecture
âœ… **Convex as the primary database** â€“ Real-time, serverless, fully managed
âœ… **Inngest for all AI agent workflows** â€“ Event-driven background jobs
âœ… **Tailwind CSS + ShadCN UI + HeroUI for styling** â€“ Utility-first design with accessible UI components
âœ… **All business logic in Server Actions or Convex functions**
âœ… **Folder names like `(auth)` are for grouping, not routes**

âŒ **No REST API routes unless absolutely necessary**
âŒ **No direct database access** â€“ All data interactions must go through Convex
âŒ **No client-side data fetching from Convex** â€“ Use `useQuery` or Server Functions
âŒ **No Redux or third-party state libraries** â€“ Use native React or Convex

---

### âš ï¸ Next.js 15 Dynamic Route Parameters

âœ… **Dynamic route params are Promises** â€“ `params` must be awaited
âœ… **Always type params as `Promise<{ id: string }>`**
âœ… **Destructure `params` after `await`** for correct access

Example:
```tsx
// Correct pattern for layout or page
export default async function Page({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;
  // ...use id
}
```

âŒ **Never access `params.id` directly** without awaiting
âŒ **Donâ€™t spread `params` directly** (e.g., `{...params}`)

---

### ğŸ§  AI Agents with Inngest

âœ… **Use Inngest for background workflows and AI processing**
âœ… **Events should be lightweight triggers only**
âœ… **Long-running AI actions (e.g., OpenAI, OCR) must run in Inngest jobs**
âœ… **Job output must be written back to Convex** with jobId traceability

Example:
```ts
export const processDocket = inngest.createFunction(
  { id: "process-docket" },
  { event: "docket/created" },
  async ({ event, step }) => {
    const pdf = await step.run("download-pdf", async () => fetchPDF(event.data.url));
    const parsed = await step.run("run-ocr", () => runOCR(pdf));
    await db.insert("case_analysis", { ...parsed, jobId: event.id });
  }
);
```

---

### ğŸ”„ Data Access & Fetching with Convex

âœ… **Use `useQuery(api.table.function)` for real-time queries**
âœ… **Use `useMutation(api.table.function)` for updates**
âœ… **Use Convex Server Functions for all backend logic**
âœ… **Donâ€™t overfetch fields â€“ query only what you need**

Example:
```tsx
const communities = useQuery(api.communities.list);
return communities?.map((c) => <div key={c._id}>{c.name}</div>);
```

---

### ğŸ¨ Styling & UI

âœ… **Tailwind CSS for layout and spacing**
âœ… **Shadcn UI for base components** (e.g., buttons, modals, toggles)
âœ… **Responsive-first with mobile defaults**
âœ… **Use `@/components/ui/` for custom or overridden Shadcn components**

âŒ **Do not override global styles unless absolutely needed**
âŒ **Avoid CSS-in-JS unless scoped to a single component**

---

### ğŸ§ª TypeScript & Developer Experience

âœ… **All files are `.tsx` or `.ts` â€“ no JavaScript**
âœ… **Types must be inferred or explicitly declared**
âœ… **Use `zod` or Convex `v` validators for runtime validation**
âœ… **Enable strict mode in `tsconfig.json`**

---

### ğŸ“Š Data Modeling with Convex

âœ… **Each record should include creation timestamps**
âœ… **Use `v.union` and `v.literal` for enums and roles**
âœ… **Model ownership with `v.id()` references**

Example:
```ts
export default defineSchema({
  users: defineTable({
    name: v.string(),
    email: v.optional(v.string()),
    role: v.union(v.literal("USER"), v.literal("ADMIN")),
  }).index("by_email", ["email"]),
});
```

---

### ğŸ” Authentication & Authorization

âœ… **Use your preferred auth provider (e.g., Clerk, Auth.js)**
âœ… **Store user identity and roles in Convex**
âœ… **Protect server functions with role checks**

Example:
```ts
export const protectedQuery = query({
  args: {},
  handler: async (ctx) => {
    if (ctx.user?.role !== "ADMIN") throw new Error("Unauthorized");
    // ...
  },
});
```

---

### ğŸ“ˆ Performance & Monitoring

âœ… **Lazy load heavy components**
âœ… **Use `next/image` for optimized media**
âœ… **Track execution time in AI jobs and Convex functions**
âœ… **Add error logging to Sentry or similar**

---

### ğŸ›¡ï¸ Security Practices

âœ… **Validate all input with Zod or Convex `v`**
âœ… **Restrict data access via Convex ACLs**
âœ… **Limit AI job scopes with clear purpose and access**
âœ… **All sensitive tokens must be in env vars**

---

### âœ… Final Rule: All new features must adhere to these rules and be reviewed for architecture alignment before merging.

---

